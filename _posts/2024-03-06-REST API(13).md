---
title: REST API(13) REST API ë³´ì•ˆ ì ìš©
date: 2024-03-06 00:00:00 +0900
categories: [âš™ï¸Back-End, ğŸƒSpring]
tags: [Spring,
RESTful,
REST,
API,
REST API,
RESTful API,
HATEOAS,
Self-descriptive,
]     
---  
## REST API ë³´ì•ˆ ì ìš©  
ìš°ë¦¬ê°€ ì§€ê¸ˆê¹Œì§€ êµ¬í˜„í•œ APIëŠ” ì „í˜€ ì™„ë²½í•˜ì§€ ì•Šë‹¤. ê°€ì¥ í° ì´ìœ ì¤‘ í•˜ë‚˜ê°€ **ì¸ì¦**ì´ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤.  
ì˜ˆë¥¼ ë“¤ì–´, ì´ë²¤íŠ¸ë¥¼ ë§Œë“¤ìœ¼ë ¤ë©´ ì ì–´ë„ ì´ ì‹œìŠ¤í…œì—ì„œ ì¸ì¦ì´ ëœ ì‚¬ìš©ìê°€ ë§Œë“¤ ìˆ˜ ìˆì–´ì•¼í•œë‹¤. í•˜ì§€ë§Œ, ì§€ê¸ˆì˜ APIëŠ” ì•„ë¬´ë‚˜ ì´ë²¤íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤. ë˜, ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•¨ì— ìˆì–´ì„œë„ ì´ë²¤íŠ¸ë¥¼ ë§Œë“  ì‚¬ëŒë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ì•¼í•˜ë‚˜, ì´ ë˜í•œ ëˆ„êµ¬ë“  ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.  
ê·¸ë˜ì„œ ì´ì œë¶€í„° ì¸ì¦ ì‹œìŠ¤í…œì„ ë„ì…í•´ë³´ì.  
  
---  
## êµ¬í˜„ Package ë° Class  


---  
## Account ë„ë©”ì¸  
```java
package me.hantomas.restapi.accounts;

import lombok.*;

import javax.persistence.*;
import java.util.Set;
@Entity
@Getter @Setter @EqualsAndHashCode(of ="id")
@Builder @NoArgsConstructor @AllArgsConstructor
public class Account {
    @Id @GeneratedValue
    private Integer id;

    private String email;

    private String password;

    @ElementCollection(fetch = FetchType.EAGER)
    @Enumerated(EnumType.STRING)
    private Set<AccountRole> roles;
}

```  
* **`@ElementCollection(fetch = FetchType.EAGER)`** : í•˜ë‚˜ì˜ enumì´ ì•„ë‹Œ, ì—¬ëŸ¬ê°œì˜ enumì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ `@ElementCollection`ìœ¼ë¡œ ì„ ì–¸í•œë‹¤. fetchì˜ ê¸°ë³¸ê°’ì€ `lazy`ì¸ë°, enumê°’ì´ ì†Œìˆ˜ì´ê¸°ë„ í•˜ê³ , ë§¤ë²ˆ accountì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ë§ˆë‹¤ í•„ìš”í•œ ì •ë³´ì´ë¯€ë¡œ `fetch = FetchType.EAGER`ë¡œ ì„ ì–¸í•œë‹¤.  
    * `@ElementCollection` : ì»¬ë ‰ì…˜ ê°ì²´ì„ì„ JPAê°€ ì•Œ ìˆ˜ ìˆê²Œ í•˜ê²Œ í•œë‹¤. ì—”í‹°í‹°ê°€ ì•„ë‹Œ ê°’ íƒ€ì…, ì„ë² ë””ë“œ íƒ€ì…ì— ëŒ€í•œ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  1ëŒ€ë‹¤ ê´€ê³„ë¡œ ë‹¤ë£¬ë‹¤.  

  
### AccountRole  
```java
package me.hantomas.restapi.accounts;

public enum AccountRole {
    ADMIN, USER
}

```  
  
## Event  
```java
package me.hantomas.restapi.events;

import lombok.*;
import me.hantomas.restapi.accounts.Account;

import javax.persistence.*;
import java.time.LocalDateTime;

@Builder @AllArgsConstructor @NoArgsConstructor
@Getter @Setter @EqualsAndHashCode(of = "id")
@Entity
public class Event {
    @Id @GeneratedValue
    private Integer id;
    private String name;
    private String description;
    private LocalDateTime beginEnrollmentDateTime;
    private LocalDateTime closeEnrollmentDateTime;
    private LocalDateTime beginEventDateTime;
    private LocalDateTime endEventDateTime;
    private String location;
    private int basePrice;
    private int maxPrice;
    private int limitOfEnrollment;
    private boolean offline;
    private boolean free;
    @Enumerated(EnumType.STRING)
    private EventStatus eventStatus = EventStatus.DRAFT;
    @ManyToOne  // ì¶”ê°€
    private Account manager;

    public void update(){
        // Update free
        if(this.basePrice == 0 && this.maxPrice == 0){
            this.free = true;
        } else{
            this.free = false;
        }

        // Update offline
        if(this.location == null || this.location.isBlank()){
            this.offline = false;
        } else{
            this.offline = true;
        }
    }
}

```
* Eventì—ì„œ Accountë¥¼ ë‹¨ë°©í–¥ìœ¼ë¡œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ `@ManyToOne` ì„ ì–¸  
    * ì´ë²¤íŠ¸ì— ëŒ€í•œ ê´€ë¦¬ì.  

---  
## Spring Security ì ìš©  
ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ëŠ” ê¸°ëŠ¥ì„ í¬ê²Œ ë‘ ê°€ì§€ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.  
* ì›¹ ì‹œíë¦¬í‹° : ì›¹ ìš”ì²­ì— ë³´ì•ˆ ì¸ì¦ (Filter ê¸°ë°˜ ì‹œíë¦¬í‹°)  
* ë©”ì†Œë“œ ì‹œíë¦¬í‹° : ì›¹ê³¼ ìƒê´€ì—†ì´ ì–´ë–¤ ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ì—ˆì„ ë•Œ ì¸ì¦ ë˜ëŠ” ê¶Œí•œ í™•ì¸  
ê³µí†µì ìœ¼ë¡œ ì´ ë‘ ê°€ì§€ ê¸°ëŠ¥ ëª¨ë‘ `Security Interceptor` ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ì„œ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.      
* ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ì„ í—ˆìš©í• ì§€ ì•ˆí• ì§€ ê²°ì •í•˜ëŠ” ë¡œì§ì´ ë“¤ì–´ê°€ ìˆë‹¤.  
     
![image](https://github.com/han-tomas/han-tomas.github.io/assets/124488773/a8ecaefb-8f8c-4433-96ba-864acdfe82f7)   
`Security Interceptor`ê°€ ë™ì‘í•˜ëŠ” ê¸°ë³¸ì ì¸ íë¦„ ë‹¤ìŒê³¼ ê°™ë‹¤.  
1. ìš”ì²­ì´ ì™”ì„ ë•Œ, ì´ ìš”ì²­ì„ `Servlet Filter`ê°€ ê°€ë¡œì±„ì„œ, Spring Beanì— ë“±ë¡ë˜ì–´ ìˆëŠ” `Filter SecurityInterceptor` ìª½ìœ¼ë¡œ ë³´ë‚¸ë‹¤. 
2. `Filter SecurityInterceptor`ê°€ ê·¸ ìš”ì²­ì„ ë³´ê³ , ì´ ìš”ì²­ì— Security Filterë¥¼ ì ìš©í•´ì•¼í•˜ëŠ”ì§€ ì•ˆí•´ì•¼í•˜ëŠ”ì§€ íŒë‹¨í•œë‹¤.  
3. ì ìš©ì„ í•´ì•¼í•œë‹¤ë©´, ë¹„ë¡œì†Œ `Security Intercepter`ì— ë“¤ì–´ê°€ê²Œ ëœë‹¤.  
4. `Security Intercepter`ì— ë“¤ì–´ ì™”ë‹¤ë©´, **ì¸ì¦ ì •ë³´**ë¥¼ ìš°ì„  í™•ì¸í•œë‹¤.  
5. ì¸ì¦ ì •ë³´ë¥¼ `SecurityContextHolder` ë„£ì–´ ë†“ëŠ”ë°,
    * êº¼ë‚¼ ì •ë³´ê°€ ìˆìœ¼ë©´, ì¸ì¦ëœ ì‚¬ìš©ìê°€ ìˆë‹¤.
    * ì—†ìœ¼ë©´, ì¸ì¦ì„ í•œ ì ì´ ì—†ëŠ” ê²ƒì´ë‹¤.
6. `SecurityContextHolder`ì¸ì¦ ì •ë³´ê°€ ì—†ë‹¤ë©´, `AuthenticationManager`ë¥¼ ì‚¬ìš©í•´ì„œ ë¡œê·¸ì¸ì„ í•œë‹¤.  
    * `AuthenticationManager`ì—ëŠ” ì‚¬ìš©í•˜ëŠ” ì£¼ìš”í•œ ì¸í„°í˜ì´ìŠ¤ê°€ ë‘ê°€ì§€ ìˆëŠ”ë° 
        * `UserDetailsService` 
            * ì…ë ¥ë°›ì€ usernameì— í•´ë‹¹í•˜ëŠ” passwordë¥¼ DBì—ì„œ êº¼ë‚´ì˜¨ë‹¤.
        * `PasswordEncoder`
            * `UserDetailsService`ì½ì–´ì˜¨ passwordê°€ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²ƒê³¼ ê°™ì€ì§€ ê²€ì‚¬.
            * ê°™ìœ¼ë©´ ë¡œê·¸ì¸ì´ ëœ ê²ƒì´ê³ , ê·¸ëŸ¼ `Authentication`ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ`SecurityContextHolder` ì €ì¥  
7. `SecurityContextHolder`ë¥¼ í†µí•´ ì¸ì¦ì´ ë˜ì—ˆë‹¤ë©´, `AccessDecisionManager`ë¥¼ í†µí•´ ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì ì ˆí•œì§€ í™•ì¸í•œë‹¤.  
    * ë³´í†µ ì‚¬ìš©ìì˜ `AccountRole`ë¡œ í™•ì¸í•œë‹¤.  
  
---  
### pom.xml ì˜ì¡´ì„± ì¶”ê°€  
```html
<dependency>
    <groupId>org.springframework.security.oauth.boot</groupId>
    <artifactId>spring-security-oauth2-autoconfigure</artifactId>
    <version>2.1.0.RELEASE</version>
</dependency>
```  

---  
### AccountRepository  
```java
package me.hantomas.restapi.accounts;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Optional;

public interface AccountRepository extends JpaRepository<Account, Integer> {
    Optional<Account> findByEmail(String username);
}

```  
  
---  
### AccountService(UserDetailsService êµ¬í˜„)  
```java
package me.hantomas.restapi.accounts;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Collection;
import java.util.Set;
import java.util.stream.Collectors;

@Service
public class AccountService implements UserDetailsService {

    @Autowired
    AccountRepository accountRepository;
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        Account account = accountRepository.findByEmail(username).orElseThrow(() -> new UsernameNotFoundException(username));
        return new User(account.getEmail(), account.getPassword(), authorities(account.getRoles()));
    }

    private Collection<? extends GrantedAuthority> authorities(Set<AccountRole> roles) {
        return roles.stream()
                .map(r -> new SimpleGrantedAuthority("ROLE_" + r.name()))
                .collect(Collectors.toSet());
    }
}

```  
* **`@Service`**ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì„œ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.  
* `UserDetailsService`ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ì•„ `UserDetails`ì˜ `loadUserByUsername()`ë¥¼ êµ¬í˜„í•´ì¤€ë‹¤.  
* `UserDetails`íƒ€ì…ì„ ë³´ë©´ `User`ë¼ëŠ” í´ë˜ìŠ¤ê°€ ìˆëŠ”ë°, ì´ë¥¼ ì‚¬ìš©í•´ì„œ êµ¬í˜„í•˜ë©´, ì „ì²´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‹¤ êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.  
    * Spring Securityê°€ ì œê³µí•˜ëŠ” `User`ì— `email`,`password`,`authorities(ê¶Œí•œ)`ì„ ë‹´ì•„ ë¦¬í„´í•œë‹¤.
        * `authorities(ê¶Œí•œ)`ëŠ” `"ROLE_ + USER/ADMIN` í˜•ì‹ìœ¼ë¡œ ë°”ê¿”ì¤€ë‹¤.  
  
---  
### AccountServiceTest   
```java
package me.hantomas.restapi.accounts;

import org.assertj.core.api.Assertions;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.ExpectedException;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Set;


import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Fail.fail;

@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles("test")
public class AccountServiceTest {

    @Autowired
    AccountService accountService;

    @Autowired
    AccountRepository accountRepository;
    @Test
    public void findByUsername(){
        // Given
        String password = "taejun";
        String username = "taejun@emai.com";
        Account account = Account.builder()
                .email(username)
                .password(password)
                .roles(Set.of(AccountRole.ADMIN,AccountRole.USER))
                .build();
        this.accountRepository.save(account);

        UserDetailsService userDetailsService = (UserDetailsService) accountService;
        UserDetails userDetails = userDetailsService.loadUserByUsername(username);

        // Then
        assertThat(userDetails.getPassword()).isEqualTo(password);
    }
    
}
```  
### ì˜ˆì™¸ í…ŒìŠ¤íŠ¸  
#### ë°©ë²• (1)
```java

// import ìƒëµ
import org.springframework.security.core.userdetails.UsernameNotFoundException;


@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles("test")
public class AccountServiceTest {
   
    @Autowired
    AccountService accountService;

    @Autowired
    AccountRepository accountRepository;
    @Test
    public void findByUsername(){
       // ìƒëµ
    }
    
    @Test(expected = UsernameNotFoundException.class) // ì˜ˆì™¸ í…ŒìŠ¤íŠ¸ ë°©ë²• 1
    public void findByUsernameFail(){
        String username = "random@email.com";
        accountService.loadUserByUsername(username);
    }
}
```  
![image](https://github.com/han-tomas/han-tomas.github.io/assets/124488773/da404095-64d7-41fb-afbb-c378e255bbbe)  
* ì˜ˆì™¸ íƒ€ì…ë§Œ í™•ì¸ ê°€ëŠ¥  
  
---  
#### ë°©ë²• (2)  
```java

// import ìƒëµ
import org.springframework.security.core.userdetails.UsernameNotFoundException;


@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles("test")
public class AccountServiceTest {
   
    @Autowired
    AccountService accountService;

    @Autowired
    AccountRepository accountRepository;
    @Test
    public void findByUsername(){
       // ìƒëµ
    }
    
    @Test // ìˆ˜ì •
    public void findByUsernameFail(){
        String username = "random@email.com";
        try {
            accountService.loadUserByUsername(username);
            fail("supposed to be failed");
        } catch (UsernameNotFoundException e){
            assertThat(e.getMessage()).containsSequence(username);
        }

    }
}
```  
![image](https://github.com/han-tomas/han-tomas.github.io/assets/124488773/b821d08c-c708-45ec-99d4-305da41517a0)  
* ì—ëŸ¬ ê°ì²´ë¥¼ ì§ì ‘ ë°›ì•„ì˜¤ê¸° ë•Œë¬¸ì— í›¨ì”¬ ë” ë§ì€ ì—ëŸ¬ ì •ë³´ë¥¼ í™•ì¸í•´ ë³¼ ìˆ˜ ìˆë‹¤.  
* ì½”ë“œ ì–‘ì´ ë§ì•„ì§„ë‹¤.  
  
---  
#### ë°©ë²• (3)  
```java

// import ìƒëµ
import org.hamcrest.Matchers; // ì¶”ê°€
import org.junit.Rule;  // ì¶”ê°€


import org.springframework.security.core.userdetails.UsernameNotFoundException;


@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles("test")
public class AccountServiceTest {

    @Rule
    public ExpectedException expectedException = ExpectedException.none();
   
    @Autowired
    AccountService accountService;

    @Autowired
    AccountRepository accountRepository;
    @Test
    public void findByUsername(){
       // ìƒëµ
    }
    
    @Test // ìˆ˜ì •
    public void findByUsernameFail(){
        String username = "random@email.com";
        // Expected
        expectedException.expect(UsernameNotFoundException.class);
        expectedException.expectMessage(Matchers.containsString(username));

        // When
        accountService.loadUserByUsername(username);

    }
}
```  
![image](https://github.com/han-tomas/han-tomas.github.io/assets/124488773/9b54fc0e-411c-4ec6-9eec-5e32f2788658)  
* ì½”ë“œëŠ” ê°„ê²°í•˜ë©´ì„œ ì˜ˆì™¸ íƒ€ì…ê³¼ ë©”ì‹œì§€ ëª¨ë‘ í™•ì¸ ê°€ëŠ¥  
* ì˜ˆìƒë˜ëŠ” ì˜ˆì™¸ë¥¼ ë¨¼ì € ì„ ì–¸í•´ì£¼ì–´ì•¼ í•œë‹¤. 
  
---  
## Spring Security ê¸°ë³¸ ì„¤ì •  
Spring Securityë¥¼ ì˜ì¡´ì„±ì— ì¶”ê°€í•œ ìˆœê°„, ìš°ë¦¬ê°€ `EventControllerTests`ì— êµ¬í˜„í–ˆë˜ ëª¨ë“  í…ŒìŠ¤íŠ¸ë“¤ì€ ë‹¤ìŒê³¼ ê°™ì´ ê¹¨ì§„ë‹¤.  
![image](https://github.com/han-tomas/han-tomas.github.io/assets/124488773/31a64e31-2290-4ed6-aed5-b1bd9acdc2ec)  
  
ê·¸ ì´ìœ ëŠ” ëª¨ë“  ìš”ì²­ë“¤ì´ **ì¸ì¦**ì„ í•„ìš”ë¡œ í•˜ê²Œë˜ê¸° ë•Œë¬¸ì´ë‹¤.  
Spring Securityê°€ ì˜ì¡´ì„±ì— ë“¤ì–´ìˆìœ¼ë©´, SpringBootëŠ” Spring Securityìš© ìë™ì„¤ì •ì„ ì ìš©í•´ì¤€ë‹¤. ê·¸ ìë™ ì„¤ì •ì— ì˜í•˜ë©´, ëª¨ë“  ìš”ì²­ì€ ì¸ì¦ì„ í•„ìš”ë¡œí•˜ê³ , Spring Securityê°€ ì‚¬ìš©ì í•˜ë‚˜ë¥¼ ì„ì˜ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.  
  
Spring Security ê¸°ë³¸ì„¤ì •ì„ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•´ë³´ì.  
    
> * ì‹œíë¦¬í‹° í•„í„°ë¥¼ ì ìš© X  
>   * /docs/index.html  
> * ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥  
>   * GET /api/events  
>   * GET /api/events/{id}  
> * ë¡œê·¸ì¸ í•´ì•¼ ì ‘ê·¼ ê°€ëŠ¥  
>   * POST /api/events  
>   * PUT /api/events/{id}  
>   * ...   
> * ìŠ¤í”„ë§ ì‹œíë¦¬í‹° OAuth 2.0  
>   * AuthorizationServer: OAuth2 í† í° ë°œí–‰(/oauth/token) ë° í† í° ì¸ì¦(/oauth/authorize)  
>       * Oder 0 (ë¦¬ì†ŒìŠ¤ ì„œë²„ ë³´ë‹¤ ìš°ì„  ìˆœìœ„ê°€ ë†’ë‹¤.)  
>   * ResourceServer: ë¦¬ì†ŒìŠ¤ ìš”ì²­ ì¸ì¦ ì²˜ë¦¬ (OAuth 2 í† í° ê²€ì‚¬)  
>       * Oder 3 (ì´ ê°’ì€ í˜„ì¬ ê³ ì¹  ìˆ˜ ì—†ìŒ)  
  





